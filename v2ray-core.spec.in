# Generated by go2rpm 1.3
%bcond_with             create_user

# @SOURCE_URL@
%global goipath         v2ray.com/core
%global forgeurl        @SOURCE_URL@
Version:                @VERSION@

%gometa

%global common_description %{expand:
Project V is a set of network tools that help you to build your own computer
network. It secures your network connections and thus protects your privacy.
More detail Please check https://www.v2fly.org}

%global shortname       v2ray
%global goname          %{shortname}-core
%global golicenses      LICENSE
%global godocs          README.md SECURITY.md
%global v2ray_config    %{gosourcedir}/release/config
%global v2ray_units     %{v2ray_config}/systemd/system

Name:           %{goname}
Release:        @RELEASE@%{?dist}
Summary:        A platform for building proxies to bypass network restrictions
License:        MIT
URL:            https://www.v2fly.org

# Source is created by:
# curl -L @SOURCE_URL@/archive/@TAG@/@NAME@-@VERSION@.tar.gz -o @NAME@-@VERSION@.tar.gz
# tar -xzf @NAME@-@VERSION@.tar.gz
# cd @NAME@-@VERSION@
# go mod vendor
# tar -czf ../vendor.tar.gz vendor
# cd ..
# rm -rf @NAME@-@VERSION@
Source0:        %{gosource}
Source1:        vendor.tar.gz
# use created user for v2ray
Source10:       systemd-create-user.sed

BuildRequires:  systemd-rpm-macros

%{?systemd_requires}
Requires(pre):  shadow-utils
Requires:       glibc
Recommends:     v2ray-geoip
Recommends:     v2ray-domain-list-community

Provides:       %{shortname} = %{version}-%{release}
Obsoletes:      %{shortname} < 4.32.1-2


%description
%{common_description}


%prep
# prep: sources
%if 0%{?fedora}
%goprep
%else
%forgeautosetup
%global gobuilddir %{_builddir}/%{archivename}/_build
if [[ ! -e "%{gobuilddir}/bin" ]] ; then
    install -m 0755 -vd %{gobuilddir}/bin
    export GOPATH="%{gobuilddir}"
fi
%global gosourcedir %{gobuilddir}/src/%{goipath}
if [[ ! -e "%{gosourcedir}" ]] ; then
    install -m 0755 -vd $(dirname %{gosourcedir})
    ln -fs %{_builddir}/%{archivename} %{gosourcedir}
fi
cd %{gosourcedir}
%endif
# prep: go vendor
%setup -qTD -a 1


%build
# build: binaries
export LDFLAGS="-linkmode=external "
%gobuild -o %{gobuilddir}/bin/v2ray %{goipath}/main
unset LDFLAGS

%if 0%{?fedora}
export LDFLAGS="-linkmode=external " BUILDTAGS="confonly"
%gobuild -o %{gobuilddir}/bin/v2ctl %{goipath}/infra/control/main
unset LDFLAGS BUILDTAGS

%else
go build \
    -buildmode pie \
    -compiler gc \
    -tags="rpm_crashtraceback confonly" \
    -ldflags="-linkmode=external -X %{goipath}/version=%{version} -B 0x$(head -c20 /dev/urandom|od -An -tx1|tr -d ' \n')" \
    -trimpath \
    -a -v \
    -o %{gobuilddir}/bin/v2ctl \
    %{goipath}/infra/control/main
%endif

# build: systemd unit files
sed                    -e 's|/usr/local/bin|%{_bindir}|g'     \
                       -e 's|/usr/local/etc|%{_sysconfdir}|g' \
%{?with_create_user:   -f %{S:10} } \
                       %{v2ray_units}/v2ray.service > %{gobuilddir}/v2ray.service

sed                    -e 's|/usr/local/bin|%{_bindir}|g'     \
                       -e 's|/usr/local/etc|%{_sysconfdir}|g' \
%{?with_create_user:   -f %{S:10} } \
                       %{v2ray_units}/v2ray@.service > %{gobuilddir}/v2ray@.service

%install
# install: binaries
install -m 0755 -vd                               %{buildroot}%{_bindir}
install -m 0755 -vp %{gobuilddir}/bin/v2ray       %{buildroot}%{_bindir}/v2ray
install -m 0755 -vp %{gobuilddir}/bin/v2ctl       %{buildroot}%{_bindir}/v2ctl
# install: config dir
install -m 0755 -vd                               %{buildroot}%{_sysconfdir}/v2ray
# install: systemd unit files
install -m 0755 -vd                               %{buildroot}%{_unitdir}
install -m 0644 -vp %{gobuilddir}/v2ray.service   %{buildroot}%{_unitdir}/v2ray.service
install -m 0644 -vp %{gobuilddir}/v2ray@.service  %{buildroot}%{_unitdir}/v2ray@.service
# install: v2ray assets directory
install -m 0755 -vd                               %{buildroot}%{_datadir}/v2ray


%files
%license %{golicenses}
%doc %{godocs}
# binaries
%{_bindir}/v2ray
%{_bindir}/v2ctl
# config dir
%dir %{_sysconfdir}/v2ray
# systemd unit files
%{_unitdir}/v2ray.service
%{_unitdir}/v2ray@.service
# v2ray assets directory
%dir %{_datadir}/v2ray


# Scriptlets >>
%{?with_create_user:
%pre
getent group %{shortname} >/dev/null || groupadd -r %{shortname}
getent passwd %{shortname} >/dev/null || \
    (useradd -r \
    -g %{shortname} \
    -d %{_localstatedir}/%{shortname} \
    -s /sbin/nologin \
    -c "User for running %{shortname}" %{shortname} && \
    echo "  User %{shortname} created.")
exit 0
}

%post
%systemd_post v2ray.service
%systemd_post v2ray@.service

%preun
%systemd_preun v2ray.service

if [ $1 -eq 0 ]; then
    # Package removal, not upgrade
    if [ -x /usr/bin/systemctl ]; then
        # systemd_preun uses systemctl disable --now which doesn't work well with template services.
        # See https://github.com/systemd/systemd/issues/15620
        # The following lines mimicks its behaviour by running two commands:
        # disable and stop all the v2ray services
        systemctl --no-reload disable v2ray@.service || :
        systemctl stop "v2ray@*.service" || :
    fi
    %{?with_create_user:
    if (getent passwd %{shortname} >/dev/null); then
        echo "  You may need remove user v2ray mannually."
    fi
    }
fi

%postun
%systemd_postun_with_restart v2ray.service
%systemd_postun_with_restart "v2ray@*.service"
# << Scriptlets

%changelog
* @DATE@ sixg0000d <sixg0000d@gmail.com> - @VERSION@-@RELEASE@
- Update package
- For more changelogs, please see: @SOURCE_URL@/releases/tag/@TAG@
