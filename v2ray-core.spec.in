# Generated by go2rpm 1.3
%bcond_without          vendor
%bcond_without          check

# @SOURCE_URL@
%global goipath         v2ray.com/core
%global forgeurl        @SOURCE_URL@
Version:                @VERSION@

%gometa

%global common_description %{expand:
Project V is a set of network tools that help you to build your own computer
network. It secures your network connections and thus protects your privacy.
More detail Please check https://www.v2fly.org/}

%global shortname       v2ray
%global goname          %{shortname}-core
%global golicenses      LICENSE
%global godocs          README.md SECURITY.md
%global v2ray_config    %{gosourcedir}/release/config
%global v2ray_units     %{v2ray_config}/systemd/system

Name:           %{goname}
Release:        @RELEASE@%{?dist}
Summary:        A platform for building proxies to bypass network restrictions
License:        MIT
URL:            %{gourl}

# Source is created by:
# curl -L @SOURCE_URL@/archive/@TAG@/@NAME@-@VERSION@.tar.gz -o @NAME@-@VERSION@.tar.gz
# tar -xzf @NAME@-@VERSION@.tar.gz
# cd @NAME@-@VERSION@
# go mod vendor
# tar -czf ../vendor.tar.gz vendor
# cd ..
# rm -rf @NAME@-@VERSION@
Source0:        %{gosource}
%if %{with vendor}
Source1:        vendor.tar.gz
%endif
# sed script files
Source10:       systemd-rename-user.sed
Source11:       systemd-multi-configs.sed
# v2ray config file templates
Source20:       empty.json
Source21:       00_log.json
Source22:       03_routing.json
Source23:       06_outbounds.json


BuildRequires:  systemd-rpm-macros
%if %{with vendor}
Provides:       bundled(golang(github.com/golang/mock/gomock))
Provides:       bundled(golang(github.com/golang/protobuf/proto))
Provides:       bundled(golang(github.com/gorilla/websocket))
Provides:       bundled(golang(github.com/lucas-clemente/quic-go))
Provides:       bundled(golang(github.com/pires/go-proxyproto))
Provides:       bundled(golang(github.com/seiflotfy/cuckoofilter))
Provides:       bundled(golang(github.com/v2fly/VSign/signerVerify))
Provides:       bundled(golang(go.starlark.net/starlark))
Provides:       bundled(golang(go.starlark.net/syntax))
Provides:       bundled(golang(golang.org/x/crypto/chacha20poly1305))
Provides:       bundled(golang(golang.org/x/crypto/hkdf))
Provides:       bundled(golang(golang.org/x/crypto/sha3))
Provides:       bundled(golang(golang.org/x/net/dns/dnsmessage))
Provides:       bundled(golang(golang.org/x/net/http2))
Provides:       bundled(golang(golang.org/x/net/http2/h2c))
Provides:       bundled(golang(golang.org/x/sys/unix))
Provides:       bundled(golang(google.golang.org/grpc))
Provides:       bundled(golang(google.golang.org/grpc/codes))
Provides:       bundled(golang(google.golang.org/grpc/reflection))
Provides:       bundled(golang(google.golang.org/grpc/status))
Provides:       bundled(golang(google.golang.org/protobuf/reflect/protoreflect))
Provides:       bundled(golang(google.golang.org/protobuf/runtime/protoimpl))
Provides:       bundled(golang(github.com/google/go-cmp/cmp))
Provides:       bundled(golang(github.com/google/go-cmp/cmp/cmpopts))
Provides:       bundled(golang(github.com/miekg/dns))
Provides:       bundled(golang(github.com/stretchr/testify/assert))
Provides:       bundled(golang(golang.org/x/net/proxy))
Provides:       bundled(golang(golang.org/x/sync/errgroup))
Provides:       bundled(golang(h12.io/socks))
%else
BuildRequires:  golang(github.com/golang/mock/gomock)
BuildRequires:  golang(github.com/golang/protobuf/proto)
BuildRequires:  golang(github.com/gorilla/websocket)
BuildRequires:  golang(github.com/lucas-clemente/quic-go)
BuildRequires:  golang(github.com/pires/go-proxyproto)
BuildRequires:  golang(github.com/seiflotfy/cuckoofilter)
BuildRequires:  golang(github.com/v2fly/VSign/signerVerify)
BuildRequires:  golang(go.starlark.net/starlark)
BuildRequires:  golang(go.starlark.net/syntax)
BuildRequires:  golang(golang.org/x/crypto/chacha20poly1305)
BuildRequires:  golang(golang.org/x/crypto/hkdf)
BuildRequires:  golang(golang.org/x/crypto/sha3)
BuildRequires:  golang(golang.org/x/net/dns/dnsmessage)
BuildRequires:  golang(golang.org/x/net/http2)
BuildRequires:  golang(golang.org/x/net/http2/h2c)
BuildRequires:  golang(golang.org/x/sys/unix)
BuildRequires:  golang(google.golang.org/grpc)
BuildRequires:  golang(google.golang.org/grpc/codes)
BuildRequires:  golang(google.golang.org/grpc/reflection)
BuildRequires:  golang(google.golang.org/grpc/status)
BuildRequires:  golang(google.golang.org/protobuf/reflect/protoreflect)
BuildRequires:  golang(google.golang.org/protobuf/runtime/protoimpl)
%if %{with check}
# Tests
BuildRequires:  golang(github.com/google/go-cmp/cmp)
BuildRequires:  golang(github.com/google/go-cmp/cmp/cmpopts)
BuildRequires:  golang(github.com/miekg/dns)
BuildRequires:  golang(github.com/stretchr/testify/assert)
BuildRequires:  golang(golang.org/x/net/proxy)
BuildRequires:  golang(golang.org/x/sync/errgroup)
BuildRequires:  golang(h12.io/socks)
%endif
%endif

%{?systemd_requires}
Requires(pre):  shadow-utils
Requires:       glibc
Recommends:     v2ray-geoip
Recommends:     v2ray-domain-list-community

Provides:       %{shortname} = %{version}-%{release}
Obsoletes:      %{shortname} < 4.32.1-2


%description
%{common_description}

%if %{without vendor}
%gopkg
%endif


%prep
# prep: sources
%if 0%{?rhel}
%forgesetup
%global gobuilddir %{_builddir}/%{archivename}/_build
if [[ ! -e "%{gobuilddir}/bin" ]] ; then
    install -m 0755 -vd %{gobuilddir}/bin
    export GOPATH="%{gobuilddir}"
fi
%global gosourcedir %{gobuilddir}/src/%{goipath}
if [[ ! -e "%{gosourcedir}" ]] ; then
    install -m 0755 -vd $(dirname %{gosourcedir})
    ln -fs %{_builddir}/%{archivename} %{gosourcedir}
fi
cd %{gosourcedir}
%else
%goprep
%endif

%if %{with vendor}
%setup -qTD -a 1
%endif


%build
# build: binaries
export LDFLAGS="-linkmode=external "
%gobuild -o %{gobuilddir}/bin/v2ray %{goipath}/main
unset LDFLAGS

%if 0%{?rhel}
go build \
    -buildmode pie \
    -compiler gc \
    -tags="rpm_crashtraceback confonly" \
    -ldflags="-linkmode=external -X %{goipath}/version=@VERSION@ -B 0x$(head -c20 /dev/urandom|od -An -tx1|tr -d ' \n')" \
    -trimpath \
    -a -v \
    -o %{gobuilddir}/bin/v2ctl \
    %{goipath}/infra/control/main

%else
export LDFLAGS="-linkmode=external " BUILDTAGS="confonly"
%gobuild -o %{gobuilddir}/bin/v2ctl %{goipath}/infra/control/main
unset LDFLAGS BUILDTAGS
%endif

# build: systemd unit files
sed -e 's|/usr/local/bin|%{_bindir}|g' \
    -e 's|/usr/local/etc|%{_sysconfdir}|g' \
    -f %{S:10} \
%if 0%{?rhel}
    -f %{S:11} \
%endif
    %{v2ray_units}/v2ray.service > %{gobuilddir}/v2ray.service

sed -e 's|/usr/local/bin|%{_bindir}|g' \
    -e 's|/usr/local/etc|%{_sysconfdir}|g' \
    -f %{S:10} \
    %{v2ray_units}/v2ray@.service > %{gobuilddir}/v2ray@.service


%install
%if %{without vendor}
%gopkginstall
%endif

# install: binaries
install -m 0755 -vd                               %{buildroot}%{_bindir}
install -m 0755 -vp %{gobuilddir}/bin/v2ray       %{buildroot}%{_bindir}/v2ray
install -m 0755 -vp %{gobuilddir}/bin/v2ctl       %{buildroot}%{_bindir}/v2ctl
# install: config file
install -m 0755 -vd                               %{buildroot}%{_sysconfdir}/v2ray
%if 0%{?rhel}
install -m 0644 -vp %{S:20}                       %{buildroot}%{_sysconfdir}/v2ray/01_api.json
install -m 0644 -vp %{S:20}                       %{buildroot}%{_sysconfdir}/v2ray/02_dns.json
install -m 0644 -vp %{S:20}                       %{buildroot}%{_sysconfdir}/v2ray/04_policy.json
install -m 0644 -vp %{S:20}                       %{buildroot}%{_sysconfdir}/v2ray/05_inbounds.json
install -m 0644 -vp %{S:20}                       %{buildroot}%{_sysconfdir}/v2ray/07_transport.json
install -m 0644 -vp %{S:20}                       %{buildroot}%{_sysconfdir}/v2ray/08_stats.json
install -m 0644 -vp %{S:20}                       %{buildroot}%{_sysconfdir}/v2ray/09_reverse.json
install -m 0644 -vp %{S:21}                       %{buildroot}%{_sysconfdir}/v2ray/00_log.json
install -m 0644 -vp %{S:22}                       %{buildroot}%{_sysconfdir}/v2ray/03_routing.json
install -m 0644 -vp %{S:23}                       %{buildroot}%{_sysconfdir}/v2ray/06_outbounds.json
%else
install -m 0644 -vp %{v2ray_config}/config.json   %{buildroot}%{_sysconfdir}/v2ray/config.json
%endif
# install: systemd unit files
install -m 0755 -vd                               %{buildroot}%{_unitdir}
install -m 0644 -vp %{gobuilddir}/v2ray.service   %{buildroot}%{_unitdir}/v2ray.service
install -m 0644 -vp %{gobuilddir}/v2ray@.service  %{buildroot}%{_unitdir}/v2ray@.service
# install: v2ray assets directory
install -m 0755 -vd                               %{buildroot}%{_datadir}/v2ray


%if %{with check}
%check
go test \
    -buildmode pie \
    -compiler gc \
    -tags="rpm_crashtraceback" \
    -ldflags="-linkmode=external -X v2ray.com/core/version=@VERSION@ -B 0x$(head -c20 /dev/urandom|od -An -tx1|tr -d ' \n')" \
    -trimpath \
    -a -v \
    %{goipath}
%endif


%files
%license %{golicenses}
%doc %{godocs}
# binaries
%{_bindir}/v2ray
%{_bindir}/v2ctl
# config file
%dir %{_sysconfdir}/v2ray
%if 0%{?rhel}
%config(noreplace) %{_sysconfdir}/v2ray/00_log.json
%config(noreplace) %{_sysconfdir}/v2ray/01_api.json
%config(noreplace) %{_sysconfdir}/v2ray/02_dns.json
%config(noreplace) %{_sysconfdir}/v2ray/03_routing.json
%config(noreplace) %{_sysconfdir}/v2ray/04_policy.json
%config(noreplace) %{_sysconfdir}/v2ray/05_inbounds.json
%config(noreplace) %{_sysconfdir}/v2ray/06_outbounds.json
%config(noreplace) %{_sysconfdir}/v2ray/07_transport.json
%config(noreplace) %{_sysconfdir}/v2ray/08_stats.json
%config(noreplace) %{_sysconfdir}/v2ray/09_reverse.json
%else
%config(noreplace) %{_sysconfdir}/v2ray/config.json
%endif
# systemd unit files
%{_unitdir}/v2ray.service
%{_unitdir}/v2ray@.service
# v2ray assets directory
%dir %{_datadir}/v2ray

%if %{without vendor}
%gopkgfiles
%endif


# Scriptlets >>
%pre
getent group %{shortname} >/dev/null || groupadd -r %{shortname}
getent passwd %{shortname} >/dev/null || \
    (useradd -r \
    -g %{shortname} \
    -d %{_localstatedir}/%{shortname} \
    -s /sbin/nologin \
    -c "User for running %{shortname}" %{shortname} && \
    echo "  User %{shortname} created.")
exit 0

%post
%systemd_post v2ray.service
%systemd_post v2ray@.service

%preun
%systemd_preun v2ray.service

if [ $1 -eq 0 ]; then
    # Package removal, not upgrade
    if [ -x /usr/bin/systemctl ]; then
        # systemd_preun uses systemctl disable --now which doesn't work well with template services.
        # See https://github.com/systemd/systemd/issues/15620
        # The following lines mimicks its behaviour by running two commands:
        # disable and stop all the v2ray services
        systemctl --no-reload disable v2ray@.service || :
        systemctl stop "v2ray@*.service" || :
    fi
    if (getent passwd %{shortname} >/dev/null); then
        echo "  You may should remove user v2ray mannually."
    fi
fi

%postun
%systemd_postun_with_restart v2ray.service
%systemd_postun_with_restart "v2ray@*.service"
# << Scriptlets

%changelog
* @DATE@ sixg0000d <sixg0000d@gmail.com> - @VERSION@-@RELEASE@
- Update package
- For more changelogs, please see: @SOURCE_URL@/releases/tag/@TAG@
